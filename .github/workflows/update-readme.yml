name: Update README

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate README content
        run: |
          python -c '
import os
from datetime import datetime

LANGUAGE_MAP = {
    ".java": "Java",
    ".rs": "Rust",
    ".go": "Go",
    ".py": "Python"
}

DIFFICULTY_MAP = {
    "0001-two-sum": ("Easy", "Two Sum"),
    "0002-add-two-numbers": ("Medium", "Add Two Numbers"),
    "0015-3sum": ("Medium", "3Sum"),
    "0042-trapping-rain-water": ("Hard", "Trapping Rain Water"),
    # 添加更多题目时，在这里补充，或后续我们用 API 自动获取
}

problems = []
language_stats = {lang: 0 for lang in LANGUAGE_MAP.values()}
total = easy = medium = hard = 0

for folder in sorted(os.listdir(".")):
    if not folder.startswith("0") or not os.path.isdir(folder):
        continue
    number = folder.split("-", 1)[0]
    slug = folder.split("-", 1)[1] if "-" in folder else ""

    difficulty, title = DIFFICULTY_MAP.get(folder, ("Unknown", slug.replace("-", " ").title()))

    supported_langs = []
    if os.path.isdir(folder):
        for file in os.listdir(folder):
            if file.startswith("solution."):
                ext = os.path.splitext(file)[1]
                if ext in LANGUAGE_MAP:
                    lang_name = LANGUAGE_MAP[ext]
                    supported_langs.append(lang_name)
                    language_stats[lang_name] += 1

    if supported_langs:
        problems.append({
            "number": number,
            "title": title,
            "link": f"https://leetcode.com/problems/{slug}/",
            "difficulty": difficulty,
            "langs": ", ".join(sorted(supported_langs)),
            "date": datetime.fromtimestamp(os.path.getmtime(folder)).strftime("%Y-%m-%d")
        })
        total += 1
        if difficulty == "Easy": easy += 1
        elif difficulty == "Medium": medium += 1
        elif difficulty == "Hard": hard += 1

table_lines = [
    "| 编号 | 标题 | 难度 | 支持语言 | 更新时间 |",
    "|------|------|------|----------|----------|"
]
for p in problems:
    table_lines.append(f"| {p["number"]} | [{p["title"]}]({p["link"]}) | {p["difficulty"]} | {p["langs"]} | {p["date"]} |")

stats_section = (
    "## 刷题进度\\n\\n"
    f"- 已解决题目：{total}\\n"
    f"- Easy：{easy}\\n"
    f"- Medium：{medium}\\n"
    f"- Hard：{hard}\\n\\n"
    "## 语言统计\\n\\n"
    f"- Java：{language_stats["Java"]} 题\\n"
    f"- Rust：{language_stats["Rust"]} 题\\n"
    f"- Go：{language_stats["Go"]} 题\\n"
    f"- Python：{language_stats["Python"]} 题\\n\\n"
    "## 题目列表\\n\\n"
    + "\\n".join(table_lines)
)

with open("new_sections.txt", "w", encoding="utf-8") as f:
    f.write(stats_section)
          ' > /dev/null  # 可选：隐藏输出

      - name: Update README
        run: |
          python -c '
import re

with open("README.md", "r", encoding="utf-8") as f:
    content = f.read()

new_sections = open("new_sections.txt").read().rstrip()

start = content.find("## 刷题进度")
end = content.find("## 其他")

if start != -1 and end != -1:
    updated = content[:start] + new_sections + "\n\n" + content[end:]
else:
    updated = content + "\n" + new_sections

with open("README.md", "w", encoding="utf-8") as f:
    f.write(updated)
          '

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to README"
          else
            git commit -m "Auto update README stats and table"
            git push
          fi
